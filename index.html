<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Paint-by-Numbers Pro</title>

<style>
body{
  font-family: 'Segoe UI', Arial;
  background: linear-gradient(135deg,#141e30,#243b55);
  min-height:100vh;
  margin:0;
  color:white;
  display:flex;
  justify-content:center;
  align-items:center;
}

.app-box{
  width:95%;
  max-width:1100px;
  background:#ffffff10;
  backdrop-filter: blur(12px);
  border-radius:18px;
  padding:25px 35px;
  box-shadow:0 25px 60px rgba(0,0,0,.4);
}

h1{
  text-align:center;
  margin-top:0;
  letter-spacing:1px;
}

button{
  border:none;
  padding:10px 20px;
  border-radius:10px;
  cursor:pointer;
  font-size:16px;
  transition:.25s;
  font-weight:600;
}

.primary{
  background:#4CAF50;
  color:white;
}
.primary:hover{
  transform:translateY(-2px);
  background:#66bb6a;
  box-shadow:0 8px 18px rgba(0,0,0,.35);
}

.secondary{
  background:#2196F3;
  color:white;
}
.secondary:hover{
  background:#42a5f5;
  transform:translateY(-2px);
}

.danger{
  background:#e53935;
  color:white;
}
.danger:hover{
  background:#ef5350;
  transform:translateY(-2px);
}

input, select{
  padding:8px 12px;
  border-radius:8px;
  border:none;
  outline:none;
}

.card{
  background:#00000025;
  padding:15px;
  border-radius:15px;
  margin-top:15px;
}

canvas{
  max-width:100%;
  border:2px solid #ffffff30;
  border-radius:12px;
  margin-top:12px;
}
</style>
</head>

<body>

<div class="app-box">

<!-- NAME STEP -->
<div id="step1">
  <h1>ðŸŽ¨ Paint-by-Numbers Pro</h1>

  <div class="card">
    <h3>Welcome!</h3>
    <p>Type your name so we can personalize your workspace</p>

    <input id="username" placeholder="Enter your name">

    <br><br>
    <button class="primary" onclick="goToStep2()">Continue</button>
  </div>
</div>

<!-- MAIN APP -->
<div id="step2" style="display:none;">
  <h2 id="greeting"></h2>

  <div class="card">
    <h3>Upload Image</h3>
    <input type="file" id="upload" accept="image/*">

    <h3>Options</h3>
    Colors:
    <select id="colorCount">
      <option>6</option>
      <option selected>10</option>
      <option>12</option>
      <option>15</option>
    </select>

    <br><br>

    <button class="secondary" onclick="generate()">Generate</button>
    <button class="danger" onclick="resetApp()">Reset</button>
  </div>

  <div class="card">
    <h3>Result</h3>

    <p>Original (quantized)</p>
    <canvas id="canvas"></canvas>

    <p>Paint-by-Numbers Outline</p>
    <canvas id="edges"></canvas>

    <h3>Palette</h3>
    <canvas id="paletteCanvas" width="220" height="420"></canvas>

    <br>
    <button class="primary" onclick="downloadCanvas()">Download Outline</button>
  </div>
</div>

<script>
let globalImage=null;

// ---------- STEP SYSTEM ----------
function goToStep2(){
  const name=document.getElementById("username").value.trim();
  if(!name){alert("Please type your name ");return;}
  document.getElementById("step1").style.display="none";
  document.getElementById("step2").style.display="block";
  document.getElementById("greeting").innerText=`Hi, ${name}! Letâ€™s create your paint-by-numbers âœ¨`;
}

// ---------- IMAGE LOAD ----------
const upload=document.getElementById("upload");
upload.addEventListener("change",e=>{
  const file=e.target.files[0];
  const img=new Image();
  img.onload=()=>globalImage=img;
  img.src=URL.createObjectURL(file);
});

// ---------- MAIN GENERATE ----------
function generate(){
  if(!globalImage){alert("Upload an image first ðŸ“·");return;}
  const N=parseInt(document.getElementById("colorCount").value);
  runPaintApp(globalImage,N);
}

// ---------- RESET ----------
function resetApp(){
  location.reload();
}

// ---------- DOWNLOAD ----------
function downloadCanvas(){
  const c=document.getElementById("edges");
  const a=document.createElement("a");
  a.href=c.toDataURL("image/png");
  a.download="paint_by_numbers.png";
  a.click();
}

// ---------- FULL PIPELINE ----------
function runPaintApp(img,N_COLORS){

  const canvas=document.getElementById("canvas");
  const ctx=canvas.getContext("2d");
  canvas.width=img.width;
  canvas.height=img.height;
  ctx.drawImage(img,0,0);

  const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
  const data=imgData.data;

  let pixels=[];
  for(let i=0;i<data.length;i+=4){
    pixels.push([data[i],data[i+1],data[i+2]]);
  }

  const {labels,centers}=kmeans(pixels,N_COLORS);

  for(let i=0;i<labels.length;i++){
    const c=centers[labels[i]];
    data[i*4]=c[0];data[i*4+1]=c[1];data[i*4+2]=c[2];
  }
  ctx.putImageData(imgData,0,0);

  drawEdges(labels,canvas.width,canvas.height);
  drawPalette(centers);
}

// ---------- KMEANS ----------
function kmeans(pixels,k){
  let centers=pixels.slice(0,k);
  let labels=new Array(pixels.length);

  for(let iter=0;iter<8;iter++){
    for(let i=0;i<pixels.length;i++){
      let best=0,bd=1e9;
      for(let j=0;j<k;j++){
        const d=dist(pixels[i],centers[j]);
        if(d<bd){bd=d;best=j;}
      }
      labels[i]=best;
    }
    let sums=Array.from({length:k},()=>[0,0,0,0]);
    for(let i=0;i<pixels.length;i++){
      let l=labels[i];
      sums[l][0]+=pixels[i][0];
      sums[l][1]+=pixels[i][1];
      sums[l][2]+=pixels[i][2];
      sums[l][3]++;
    }
    for(let j=0;j<k;j++){
      if(sums[j][3]>0){
        centers[j]=[
          sums[j][0]/sums[j][3],
          sums[j][1]/sums[j][3],
          sums[j][2]/sums[j][3],
        ];
      }
    }
  }
  return {labels,centers};
}

function dist(a,b){
  return (a[0]-b[0])**2+(a[1]-b[1])**2+(a[2]-b[2])**2;
}

// ---------- EDGES ----------
function drawEdges(labels,w,h){
  const c=document.getElementById("edges");
  c.width=w;c.height=h;
  const ctx=c.getContext("2d");

  const img=ctx.createImageData(w,h);
  const d=img.data;

  function id(x,y){return y*w+x;}

  for(let i=0;i<d.length;i+=4){
    d[i]=d[i+1]=d[i+2]=255;d[i+3]=255;
  }

  for(let y=1;y<h-1;y++){
    for(let x=1;x<w-1;x++){
      const i=id(x,y);
      const here=labels[i];
      const n=[labels[id(x+1,y)],labels[id(x-1,y)],labels[id(x,y+1)],labels[id(x,y-1)]];
      if(n.some(v=>v!==here)){
        const p=i*4;
        d[p]=d[p+1]=d[p+2]=0;
      }
    }
  }
  ctx.putImageData(img,0,0);
}

// ---------- PALETTE ----------
function drawPalette(centers){
  const c=document.getElementById("paletteCanvas");
  const ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);


  centers.forEach((col,i)=>{
    ctx.fillStyle=`rgb(${col[0]},${col[1]},${col[2]})`;
    ctx.fillRect(20,20+i*30,40,20);
    ctx.fillStyle="white";
    ctx.fillText(i+1,80,35+i*30);
  });
}

// draw crystal-clear numbers
ctx.lineWidth = 3;

ctx.fillStyle = "white";                // white background bubble
ctx.beginPath();
ctx.arc(x, y, 14, 0, Math.PI * 2);
ctx.fill();

ctx.strokeStyle = "black";              // black border ring
ctx.stroke();

ctx.fillStyle = "black";                // number text
ctx.fillText(num, x, y);
</script>

</div>
</body>
</html>